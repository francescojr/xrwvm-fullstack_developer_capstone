<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Car Dealership</title>
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div>
        <nav class="navbar navbar-expand-lg navbar-light" style="background-color:darkturquoise; height: 1in;">
            <div class="container-fluid">
                <h2 style="padding-right: 5%;">Dealerships</h2>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarText">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" style="font-size: larger;" aria-current="page" href="/">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" style="font-size: larger;" href="/about">About Us</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" style="font-size: larger;" href="/contact">Contact Us</a>
                        </li>
                    </ul>
                    <!-- User info e logout -->
                    <span class="navbar-text" id="userSection">
                        <!-- Será preenchido dinamicamente -->
                    </span>
                </div>
            </div>
        </nav>

        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3>Login</h3>
                        </div>
                        <div class="card-body">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" name="userName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                                
                                <!-- Botões Login e Cancel -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                    <button type="submit" class="btn btn-primary flex-fill">Login</button>
                                    <button type="button" class="btn btn-secondary flex-fill" onclick="handleCancel()">Cancel</button>
                                </div>
                            </form>
                            <div id="message" class="mt-3"></div>
                        </div>
                    </div>
                    
                    <!-- Register Now Link -->
                    <div class="text-center mt-3">
                        <p>Don't have an account? <a href="/register" id="registerLink">Register Now</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Handler de logout - DEFINIR GLOBALMENTE
        window.handleLogout = async function(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            console.log('=== LOGOUT CLICKED ===');
            
            try {
                console.log('Sending logout request to /djangoapp/logout/');
                const response = await fetch('/djangoapp/logout/', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                console.log('Logout response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Logout response data:', data);
                    
                    alert('Logged out successfully!');
                    window.location.href = '/';
                } else {
                    console.error('Logout failed with status:', response.status);
                    alert('Error logging out. Status: ' + response.status);
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out: ' + error.message);
            }
            
            return false;
        };

        // Handler de cancel
        window.handleCancel = function() {
            console.log('Cancel clicked');
            document.getElementById('loginForm').reset();
            document.getElementById('message').innerHTML = '';
            window.location.href = '/';
        };

        // Verifica se o usuário está logado ao carregar a página
        async function checkUserSession() {
            try {
                console.log('Checking user session...');
                const response = await fetch('/djangoapp/get_current_user/', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('User session data:', data);
                    if (data.userName) {
                        updateUserSection(data.userName);
                    }
                }
            } catch (error) {
                console.log('No active session:', error);
            }
        }

        // Atualiza a seção do usuário no navbar
        function updateUserSection(username) {
            const userSection = document.getElementById('userSection');
            if (username) {
                userSection.innerHTML = `
                    <span class="me-3" style="color: white;">Welcome, <strong>${username}</strong></span>
                    <button class="btn btn-outline-light btn-sm" type="button" onclick="handleLogout(event); return false;">Logout</button>
                `;
                console.log('User section updated with logout button');
            } else {
                userSection.innerHTML = '';
            }
        }

        // Handler de login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('message');
            
            messageDiv.innerHTML = '';
            
            console.log('Login attempt for user:', username);
            
            try {
                const response = await fetch('/djangoapp/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        userName: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                console.log('Login response:', data);
                
                if (data.status === 'Authenticated') {
                    messageDiv.innerHTML = '<div class="alert alert-success">Login successful! Redirecting...</div>';
                    updateUserSection(username);
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    messageDiv.innerHTML = '<div class="alert alert-danger">' + (data.error || 'Invalid credentials. Please try again.') + '</div>';
                }
            } catch (error) {
                console.error('Login error:', error);
                messageDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        });

        // Verifica sessão ao carregar
        console.log('Page loaded, checking session...');
        checkUserSession();

        // Handler de logout - DEFINIR GLOBALMENTE
        window.handleLogout = async function(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        console.log('=== LOGOUT CLICKED ===');
        
        // ALERT MOSTRANDO QUE ESTÁ DESLOGANDO
        const logoutAlert = document.createElement('div');
        logoutAlert.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
        logoutAlert.style.zIndex = '9999';
        logoutAlert.innerHTML = 'Logging out...';
        document.body.appendChild(logoutAlert);
        
        try {
            console.log('Sending logout request to /djangoapp/logout/');
            const response = await fetch('/djangoapp/logout/', {
                method: 'GET',
                credentials: 'same-origin'
            });
            
            console.log('Logout response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Logout response data:', data);
                
                // Remove alert de "logging out"
                logoutAlert.remove();
                
                // ALERT DE SUCESSO
                alert('Logged out successfully!');
                
                // Redireciona
                window.location.href = '/';
            } else {
                logoutAlert.remove();
                console.error('Logout failed with status:', response.status);
                alert('Error logging out. Status: ' + response.status);
            }
        } catch (error) {
            logoutAlert.remove();
            console.error('Logout error:', error);
            alert('Error logging out: ' + error.message);
        }
        
        return false;
    };

    </script>
</body>
</html>
